    `mailout/code/README.md`

База данных получателей рассылки
================================

Каталог `mailout/code/` содержит в себе следующее:

* базу данных с получателями
* набор скриптов для упрощения рутинных действий с базой данных
* ключевые PHP классы, составляющие программное ядро `mailout`.
* подкаталог `forms`, содержащий в себе HTML-страницы, необходимые для 
  генерации формы отказа от рассылки (см. `mailout/README.md`).

Работа с базой данных
---------------------

Для упрощения работы с базой данных собрано несколько PHP-скриптов, которые
можно запускать из командной строки.

### Добавление получателей ###

Для добавления списка получателей используется скрипт `recipadd.php`.
Он запускается следующим образом:

    ./recipadd.php INFILE [GID]

Здесь `INFILE` это название файла, содержащего список адресов электронной почты,
по одному адресу на строчку. 

`GID` это условный код группы адресов, к которой относятся добавляемые адреса.

В `mailout` предопределён `GID` 666, который условно обозначает адреса для 
тестовой рассылки (см. `mailout/app/README.md`).

Если `GID` явно не указан, добавляемые адреса получат `GID` 0.

### Быстрый вывод списка получателей ###

Если нужно быстро получить список сохранённых получателей рассылки, то вызов 
   
    ./reciplist.php

выведет на консоль содержимое базы данных получателей в формате

    ID GID EMAIL OPENED HOMEPAGE CATALOG UNSUBSCRIBED

Где `ID`, `GID`, `EMAIL` говорят сами за себя, а остальные числа --- статистика:

* `OPENED` --- сколько раз открыл письмо
* `HOMEPAGE` --- сколько раз посетил главную страницу по ссылке из письма
* `CATALOG` --- сколько раз посетил каталог по ссылке из письма
* `UNSUBSCRIBED` --- равно 1, если получатель отказался от рассылки

### Очистка статистики перед новой рассылкой ###

**Следует очищать статистику перед каждым новым запуском рассылки**

Статистика в базе данных имеет значение только до следующей рассылки.
После осуществления очередной рассылки следует обнулить счётчики, иначе 
данные будут получены неверные.

Благодаря использованию SQLite старую статистику можно сохранить, просто
сделав копию файла базы данных получателей, приписав к имени файла дату.

Запуск

    ./recipur.php

осуществляет следующие действия:

1. Обнуляет счётчики посещений.
2. Сохраняет заявки на отказ от рассылки. Отказавшиеся от рассылки получатели
   будут игнорироваться при составлении следующего списка рассылки.
3. Обнуляет метки отказов от рассылки.

### Краткая текущая статистика ###

Запуск 

    ./recipstats.php

выведет в окно консоли текущую статистику по получателям.

API к базе данных
-----------------

Для программного доступа к базе данных используются три класса: `Recipient`, 
`RecipientsDB` и `RecipientsDB_WebDriver`. В качестве документации по их 
использованию можно воспользоваться модульными тестами из каталога 
`mailout/tests/` (см. `mailout/tests/README.md`).

### Получатель / `Recipient` ###

Класс `Recipient` используется в качестве обёртки вокруг записи 
из БД получателей. Он используется классом `RecipientsDB`.

### База данных получателей / `RecipientsDB` ###

Класс `RecipientsDB` основной для бэк-энда. Его интерфейс состоит из статических
методов для манипуляции с получателями непосредственно в БД. Фактически, 
`RecipientsDB` в паре с `Recipient` являются обёртками для SQL-запросов к БД.

### Веб-интерфейс к БД получателей / `RecipientsDB_WebDriver` ###

Этот класс используется кодом фронт-энда (см. `mailout/README.md`) для "бесшумного" запуска методов
`RecipientsDB`. Он подавляет все сообщения об ошибках, 
чтобы получатели рассылки, переходя по ссылке из письма на главную страницу 
сайта, в случае непредвиденных ситуаций не видели ошибки PHP и/или БД.

При возникновении ошибки в нижележащем коде методы `RecipientsDB_WebDriver`
отправляют письмо с описанием ошибки на адрес, определённый в параметре
`RecipientsDB_WebDriver::$admin_email`.

Техническая информация о базе данных
------------------------------------

База данных получателей хранится в формате SQLite3.

Бэк-энд `mailout` ожидает, что файл базы данных находится по адресу 
`mailout/code/recipients.db`.

В БД получателей определена одна таблица под названием `recipients`.
Её схема следующая:

    CREATE TABLE recipients(
        id integer primary key autoincrement,
        gid integer,
        email text,
        opened integer,
        homepage integer,
        catalog integer,
        unsubscribed integer, 
        ignore integer
    ); 

Поле `ignore` определяет, будет ли данный получатель в списке рассылки при
следующем запуске `mailout/app/mailout.php`, см. `mailout/app/README.md`.

Поле `unsubscribed` показывает, отказался ли данный получатель от *текущей* 
рассылки. Именно оно учитывается в статистике.

